<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Request Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
        }
        input, button, textarea {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Batch Request Tool</h2>
        <input type="file" id="fileInput" accept=".csv, .xlsx">
        <textarea id="systemPrompt" rows="4" placeholder="Enter system prompt here..."></textarea>
        <input type="text" id="model" placeholder="Enter model name (e.g., claude-3-5-sonnet-20241022)" value="claude-3-5-sonnet-20241022">
        <input type="number" id="maxTokens" placeholder="Enter max tokens" value="100">
        <input type="number" id="temperature" placeholder="Enter temperature (e.g., 0.7)" value="0.7" step="0.1">
        <input type="text" id="apiKey" placeholder="Enter API Key">
        <button onclick="processFile()">Process File</button>
        <a id="downloadLink" style="display:none">Download Processed CSV</a>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script>
        async function processFile() {
            const fileInput = document.getElementById('fileInput');
            const systemPrompt = document.getElementById('systemPrompt').value;
            const model = document.getElementById('model').value;
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const apiKey = document.getElementById('apiKey').value;

            if (!fileInput.files.length) {
                alert('Please upload a file (CSV or Excel).');
                return;
            }

            if (!apiKey) {
                alert('Please enter your API key.');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            if (file.name.endsWith('.csv')) {
                reader.onload = async function(e) {
                    const text = e.target.result;
                    await processCsvContent(text, systemPrompt, model, maxTokens, temperature, apiKey);
                };
                reader.readAsText(file, 'UTF-8');
            } else if (file.name.endsWith('.xlsx')) {
                reader.onload = async function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const csv = XLSX.utils.sheet_to_csv(worksheet);
                    await processCsvContent(csv, systemPrompt, model, maxTokens, temperature, apiKey);
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('Unsupported file type. Please upload a CSV or Excel file.');
            }
        }

        async function processCsvContent(csvContent, systemPrompt, model, maxTokens, temperature, apiKey) {
            const rows = csvContent.split('\n');
            const headers = rows[0].split(',');
            const idIndex = headers.indexOf('id');
            const userIndex = headers.indexOf('user');

            if (idIndex === -1 || userIndex === -1) {
                alert('CSV must contain headers: id, user');
                return;
            }

            let outputCsv = 'id,user,assistant\n';
            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].split(',');
                const userMessage = cells[userIndex];
                const id = cells[idIndex];

                if (!userMessage) continue;

                const assistantResponse = await getAssistantResponse(systemPrompt, userMessage, model, maxTokens, temperature, apiKey);
                outputCsv += `${id},"${userMessage}","${assistantResponse}"
`;
            }

            downloadCsv(outputCsv);
        }

        async function getAssistantResponse(systemPrompt, userMessage, model, maxTokens, temperature, apiKey) {
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        "model": model,
                        "max_tokens": maxTokens,
                        "temperature": temperature,
                        "messages": [
                            { "role": "system", "content": systemPrompt },
                            { "role": "user", "content": userMessage }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                if (data.completion && data.completion.messages) {
                    return data.completion.messages[data.completion.messages.length - 1].content;
                } else {
                    return 'Error: Invalid response format';
                }
            } catch (error) {
                console.error('Error fetching assistant response:', error);
                return `Error: ${error.message}`;
            }
        }

        function downloadCsv(csvContent) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = url;
            downloadLink.download = 'processed_output.csv';
            downloadLink.style.display = 'block';
        }
    </script>
</body>
</html>
